<!DOCTYPE html>
<html>
	<head>
		<title>Zoomable Canvas with Lines Between Points</title>
		<script src="https://d3js.org/d3.v6.min.js"></script>
		<style>
			#myCanvas {
				border: 1px solid #000;
			}
		</style>
	</head>
	<body>
		<canvas id="myCanvas" width="800" height="600"></canvas>
		<script>
			window.addEventListener("load", async function () {
				const canvas = document.getElementById("myCanvas");
				const offscreen = canvas.transferControlToOffscreen();
				const worker = new Worker("offscreen_worker.js");

				// Generate mock-up points
				var points = [];
				for (var i = 0; i < 100_000; i++) {
					points.push({
						x: Math.random() * 2000 - 1000,
						y: Math.random() * 2000 - 1000,
					});
				}

				// Post the offscreen canvas and points to the worker
				worker.postMessage({ canvas: offscreen, points }, [offscreen]);

				var scale = 1;
				// Event listeners for zoom and pan
				canvas.addEventListener("wheel", function (event) {
					event.preventDefault();
					// Calculate and send zoom data to worker
					var scaleFactor = 1.1;
					if (event.deltaY < 0) {
						// Zoom in
						scale *= scaleFactor;
					} else {
						// Zoom out
						scale /= scaleFactor;
					}
					scale = Math.min(Math.max(1, scale), 4); // Restrict scale between 1 and 4
					worker.postMessage({ type: "zoom", scale: scale });
					console.debug("zoom", { scale });
				});

				// var lastX = 0,
				// lastY = 0;
				var translateX = 0,
					translateY = 0;
				canvas.addEventListener("mousemove", function (event) {
					if (event.buttons === 1) {
						// var translateX = (event.clientX - lastX) / scale;
						// var translateY = (event.clientY - lastY) / scale;
						// lastX = event.clientX;
						// lastY = event.clientY;
						translateX += event.movementX / scale;
						translateY += event.movementY / scale;
						console.debug("pan", { translateX, translateY });
						worker.postMessage({ type: "pan", translateX, translateY });
					}
				});
			});
		</script>
	</body>
</html>
